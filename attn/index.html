<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attendance Pro - Analytics Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        .student-list-container { display: flex; flex-direction: column; gap: 6px; }
        .student-row {
            display: flex; align-items: center; padding: 12px 16px; border-radius: 12px;
            transition: all 0.1s ease; cursor: pointer; border: 1px solid transparent; user-select: none;
        }
        .absent { background-color: #fef2f2; border-color: #fecaca; color: #991b1b; box-shadow: inset 4px 0 0 #ef4444; }
        .present { background-color: #f0fdf4; border-color: #bbf7d0; color: #166534; box-shadow: inset 4px 0 0 #22c55e; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; margin-right: 12px; }
        .absent .status-dot { background-color: #ef4444; }
        .present .status-dot { background-color: #22c55e; }

        .sticky-summary { 
            position: fixed; bottom: 0; left: 0; right: 0;
            background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px);
            border-top: 1px solid #e2e8f0; padding: 12px; z-index: 50;
        }

        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.5);
            display: flex; align-items: center; justify-content: center; z-index: 100; padding: 20px;
        }

        /* Analytics Progress Bar */
        .progress-bg { background: #e2e8f0; height: 6px; border-radius: 3px; overflow: hidden; }
        .progress-fill { height: 100%; transition: width 0.5s ease; }

        .tab-btn-active { background: white; box-shadow: 0 1px 3px rgba(0,0,0,0.1); color: #2563eb; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 pb-24">

    <div id="app" class="max-w-xl mx-auto p-4">
        <!-- Header -->
        <header class="flex justify-between items-center mb-6">
            <div>
                <h1 class="text-2xl font-black text-blue-600 tracking-tight">Attendance Pro</h1>
                <p id="status-badge" class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Connecting...</p>
            </div>
            <div id="auth-status" class="px-3 py-1 rounded-full bg-slate-100 text-slate-500 text-[10px] font-black uppercase">
                Initializing...
            </div>
        </header>

        <!-- Navigation Tabs -->
        <div class="flex bg-slate-200 p-1 rounded-xl mb-6 text-xs font-bold">
            <button onclick="window.switchTab('mark')" id="tab-mark" class="flex-1 py-2.5 rounded-lg bg-white shadow-sm transition-all">MARKING</button>
            <button onclick="window.switchTab('report')" id="tab-report" class="flex-1 py-2.5 rounded-lg text-slate-500 transition-all">ANALYTICS</button>
        </div>

        <!-- MARKING VIEW -->
        <div id="view-mark" class="space-y-4">
            <div class="bg-white rounded-2xl shadow-sm p-5 border border-slate-200 grid grid-cols-2 gap-3">
                <div class="col-span-2">
                    <input type="text" id="facultyName" placeholder="Faculty Name" oninput="window.saveMeta()" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm outline-none focus:ring-2 focus:ring-blue-500/20">
                </div>
                <div><input type="date" id="attendanceDate" onchange="window.initSectionLoad()" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm outline-none"></div>
                <div>
                    <select id="hourSelect" onchange="window.initSectionLoad()" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm outline-none">
                        <option value="1-2">Hour 1-2</option>
                        <option value="3-4">Hour 3-4</option>
                        <option value="5-6">Hour 5-6</option>
                    </select>
                </div>
                <div>
                    <select id="sectionSelect" onchange="window.initSectionLoad()" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm font-bold text-blue-600 outline-none">
                        <option value="">Section...</option>
                        <option value="A">Section A</option>
                        <option value="B">Section B</option>
                        <option value="C">Section C</option>
                        <option value="D">Section D</option>
                        <option value="All">All Sections</option>
                    </select>
                </div>
                <div>
                    <select id="subjectSelect" onchange="window.initSectionLoad()" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm outline-none">
                        <option value="">Subject...</option>
                        <option value="Optimization Techniques">Optimization Techniques</option>
                        <option value="Machine Learning">Machine Learning</option>
                        <option value="DBMS">Database Management Systems</option>
						<option value="P&S">Probability & Statistics</option>
						<option value="DLCO">Digital Logic and Computer Organization</option>
						<option value="FS">Full Stack Development</option>
						<option value="DTI">Design Thinking & Innovation</option>
						
						<option value="ML LAB">Machine Learning Lab</option>
						<option value="DB LAB">Database Management Systems Lab</option>
                    </select>
                </div>
            </div>

            <div id="workspace" class="hidden animate-in fade-in duration-300">
                <div class="flex gap-2 mb-4">
                    <button onclick="window.bulkMark(true)" class="flex-1 py-3 bg-green-50 text-green-700 rounded-xl text-[10px] font-black uppercase border border-green-200">Mark All Present</button>
                    <button onclick="window.bulkMark(false)" class="flex-1 py-3 bg-red-50 text-red-700 rounded-xl text-[10px] font-black uppercase border border-red-200">Mark All Absent</button>
                    <button onclick="window.showClearConfirm()" class="px-4 py-3 bg-slate-100 text-slate-600 rounded-xl text-[10px] font-black uppercase border border-slate-200">Reset</button>
                </div>

                <div class="mb-4 relative">
                    <input type="text" id="studentSearch" oninput="window.renderStudents()" placeholder="Search roll or name..." class="w-full pl-11 p-3.5 bg-white border border-slate-200 rounded-2xl text-sm outline-none shadow-sm focus:ring-2 focus:ring-blue-500/20">
                    <span class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400">üîç</span>
                </div>

                <div class="flex justify-between items-center mb-2 px-1">
                    <span id="data-source-badge" class="text-[9px] font-black text-slate-400 uppercase tracking-widest">Active List</span>
                    <span id="list-info" class="text-[9px] font-bold text-slate-500 uppercase"></span>
                </div>
                <div id="student-list" class="student-list-container"></div>
            </div>

            <div id="empty-state" class="text-center py-20 bg-white border-2 border-dashed border-slate-200 rounded-3xl">
                <p class="text-sm font-medium text-slate-400">Configure session details above</p>
            </div>
        </div>

        <!-- REPORTS VIEW -->
        <div id="view-report" class="hidden space-y-4">
            <div class="bg-white rounded-2xl p-5 border border-slate-200 shadow-sm">
                <div class="grid grid-cols-2 gap-3 mb-4">
                    <div>
                        <label class="text-[9px] font-black text-slate-400 uppercase mb-1 block">From</label>
                        <input type="date" id="reportFrom" class="w-full p-3 bg-slate-50 rounded-xl text-xs border border-slate-100">
                    </div>
                    <div>
                        <label class="text-[9px] font-black text-slate-400 uppercase mb-1 block">To</label>
                        <input type="date" id="reportTo" class="w-full p-3 bg-slate-50 rounded-xl text-xs border border-slate-100">
                    </div>
                </div>
                
                <div class="flex bg-slate-100 p-1 rounded-xl mb-4 text-[10px] font-black">
                    <button onclick="window.setReportMode('sessions')" id="mode-sessions" class="flex-1 py-2 rounded-lg tab-btn-active">SESSION LOG</button>
                    <button onclick="window.setReportMode('students')" id="mode-students" class="flex-1 py-2 rounded-lg text-slate-400">STUDENT INSIGHTS</button>
                </div>

                <div class="flex gap-2">
                    <button onclick="window.generateReport()" class="flex-[2] py-4 bg-blue-600 text-white rounded-2xl font-black text-sm shadow-lg shadow-blue-200">GENERATE REPORT</button>
                    <button id="btn-export" onclick="window.exportToCSV()" class="flex-1 py-4 bg-emerald-600 text-white rounded-2xl font-black text-sm hidden">EXPORT</button>
                </div>
            </div>

            <div id="report-results" class="space-y-3"></div>
        </div>

        <!-- Sticky Footer -->
        <div id="sticky-bar" class="sticky-summary hidden">
            <div class="max-w-xl mx-auto flex gap-4 items-center">
                <div class="flex-1 text-center bg-slate-50 py-2 rounded-xl">
                    <p class="text-[8px] font-black text-slate-400 uppercase">Absentees</p>
                    <p id="absent-count" class="text-xl font-black text-red-600 leading-tight">0</p>
                </div>
                <button onclick="window.submitAttendance()" class="flex-[3] bg-slate-900 text-white py-4 rounded-2xl font-black text-sm shadow-xl hover:bg-black active:scale-95 transition-all">
                    SYNC TO CLOUD
                </button>
            </div>
        </div>
    </div>

    <!-- Custom Modals -->
    <div id="custom-modal" class="modal-overlay hidden">
        <div class="bg-white p-6 rounded-3xl max-w-sm w-full shadow-2xl">
            <h2 id="modal-title" class="text-lg font-black mb-2">Notice</h2>
            <p id="modal-body" class="text-slate-500 text-sm mb-6 leading-relaxed"></p>
            <div id="modal-actions" class="flex gap-3">
                <button onclick="window.closeModal()" class="flex-1 py-3 bg-slate-100 rounded-xl text-xs font-bold uppercase">Close</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";

        const firebaseConfig = { 
apiKey: "AIzaSyBXECIZa45dq-o8Ka4G9Y1N7nll7cyli2U",
  authDomain: "stuattnd.firebaseapp.com",
  projectId: "stuattnd",
  storageBucket: "stuattnd.firebasestorage.app",
  messagingSenderId: "511533506488",
  appId: "1:511533506488:web:aca4de3d513915d012f94d",
  measurementId: "G-9PZZM5LFKX"};
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'attendance-v7-persistence';
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let currentUser = null;
        let currentAbsentees = new Set();
        let reportData = [];
        let reportMode = 'sessions'; // 'sessions' or 'students'

        const studentsList = [
            { roll: '23091A3201', name: 'ADARSH REDDY', section: 'A' },
            { roll: '23091A3205', name: 'RAM CHARAN', section: 'A' },
            { roll: '24091A0501', name: 'AAHIL BAIG', section: 'B' },
            { roll: '24091A0538', name: 'FEDHA HUSSEN', section: 'B' },
            { roll: '24091A12A9', name: 'MOUNIKA', section: 'C' },
            { roll: '24091A1212', name: 'ANANDA MANI', section: 'C' },
            { roll: '24091A0455', name: 'SAMEER KHAN', section: 'D' },
            { roll: '23091A0488', name: 'KRISHNA V', section: 'D' }
        ];

        window.onload = async () => {
            const saved = localStorage.getItem(`active_absentees_${appId}`);
            if (saved) currentAbsentees = new Set(JSON.parse(saved));

            const initAuth = async () => {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            };
            
            await initAuth();
            onAuthStateChanged(auth, (user) => {
                currentUser = user;
                document.getElementById('auth-status').innerText = user ? "Connected" : "Offline";
                updateConnectionStatus();
            });

            document.getElementById('attendanceDate').valueAsDate = new Date();
            const lastMonth = new Date(); lastMonth.setMonth(lastMonth.getMonth() - 1);
            document.getElementById('reportFrom').valueAsDate = lastMonth;
            document.getElementById('reportTo').valueAsDate = new Date();
            document.getElementById('facultyName').value = localStorage.getItem('last_faculty') || "";
        };

        window.saveMeta = () => {
            localStorage.setItem('last_faculty', document.getElementById('facultyName').value);
        };

        window.switchTab = (tab) => {
            const isMark = tab === 'mark';
            document.getElementById('view-mark').classList.toggle('hidden', !isMark);
            document.getElementById('view-report').classList.toggle('hidden', isMark);
            document.getElementById('tab-mark').className = isMark ? "flex-1 py-2.5 rounded-lg font-bold bg-white shadow-sm transition-all" : "flex-1 py-2.5 rounded-lg font-bold text-slate-500 transition-all";
            document.getElementById('tab-report').className = !isMark ? "flex-1 py-2.5 rounded-lg font-bold bg-white shadow-sm transition-all" : "flex-1 py-2.5 rounded-lg font-bold text-slate-500 transition-all";
        };

        window.setReportMode = (mode) => {
            reportMode = mode;
            document.getElementById('mode-sessions').className = mode === 'sessions' ? 'flex-1 py-2 rounded-lg tab-btn-active' : 'flex-1 py-2 rounded-lg text-slate-400';
            document.getElementById('mode-students').className = mode === 'students' ? 'flex-1 py-2 rounded-lg tab-btn-active' : 'flex-1 py-2 rounded-lg text-slate-400';
            if(reportData.length > 0) renderReportResults();
        };

        window.initSectionLoad = () => {
            const section = document.getElementById('sectionSelect').value;
            const subject = document.getElementById('subjectSelect').value;
            if(!section || !subject) {
                document.getElementById('workspace').classList.add('hidden');
                document.getElementById('empty-state').classList.remove('hidden');
                return;
            }
            document.getElementById('empty-state').classList.add('hidden');
            document.getElementById('workspace').classList.remove('hidden');
            window.renderStudents();
        };

        window.renderStudents = () => {
            const section = document.getElementById('sectionSelect').value;
            const queryText = document.getElementById('studentSearch').value.toLowerCase();
            const listContainer = document.getElementById('student-list');
            
            const filtered = studentsList.filter(s => {
                const matchesSection = (section === 'All' || s.section === section);
                const matchesSearch = s.name.toLowerCase().includes(queryText) || s.roll.toLowerCase().includes(queryText);
                return matchesSection && matchesSearch;
            });

            document.getElementById('list-info').innerText = `${filtered.length} Students`;
            listContainer.innerHTML = filtered.map(s => {
                const isAbsent = currentAbsentees.has(s.roll);
                return `
                    <div onclick="window.toggleStatus('${s.roll}')" class="student-row ${isAbsent ? 'absent' : 'present'}">
                        <div class="status-dot"></div>
                        <div class="flex-1">
                            <p class="text-xs font-bold leading-none">${s.name}</p>
                            <p class="text-[9px] opacity-60 font-mono mt-1">${s.roll} ‚Ä¢ Sec ${s.section}</p>
                        </div>
                        <div class="text-[9px] font-black uppercase tracking-tighter">${isAbsent ? 'ABSENT' : 'PRESENT'}</div>
                    </div>
                `;
            }).join('');

            document.getElementById('absent-count').innerText = currentAbsentees.size;
            document.getElementById('sticky-bar').classList.remove('hidden');
        };

        window.toggleStatus = (roll) => {
            if(currentAbsentees.has(roll)) currentAbsentees.delete(roll);
            else currentAbsentees.add(roll);
            saveToLocal();
            window.renderStudents();
        };

        window.bulkMark = (asPresent) => {
            const section = document.getElementById('sectionSelect').value;
            studentsList.forEach(s => {
                if(section === 'All' || s.section === section) {
                    if(asPresent) currentAbsentees.delete(s.roll);
                    else currentAbsentees.add(s.roll);
                }
            });
            saveToLocal();
            window.renderStudents();
        };

        window.showClearConfirm = () => {
            window.showModal("Reset Session?", "This will clear current marks.", `<button onclick="window.clearSession(); window.closeModal();" class="flex-1 py-3 bg-red-600 text-white rounded-xl text-xs font-bold uppercase">Reset</button>`);
        };

        window.clearSession = () => {
            currentAbsentees.clear();
            saveToLocal();
            window.renderStudents();
        };

        function saveToLocal() {
            localStorage.setItem(`active_absentees_${appId}`, JSON.stringify(Array.from(currentAbsentees)));
        }

        window.submitAttendance = async () => {
            if (!currentUser) return window.showModal("Error", "System Offline");
            const faculty = document.getElementById('facultyName').value;
            if(!faculty) return window.showModal("Required", "Enter Faculty Name");

            const entry = {
                date: document.getElementById('attendanceDate').value,
                hour: document.getElementById('hourSelect').value,
                faculty,
                section: document.getElementById('sectionSelect').value,
                subject: document.getElementById('subjectSelect').value,
                absentees: Array.from(currentAbsentees),
                timestamp: Date.now()
            };

            try {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'attendance'), entry);
                window.showModal("Synced", "Attendance recorded in cloud records.");
            } catch(e) { window.showModal("Error", "Cloud sync failed."); }
        };

        window.generateReport = async () => {
            if (!currentUser) return;
            const from = document.getElementById('reportFrom').value;
            const to = document.getElementById('reportTo').value;
            const resDiv = document.getElementById('report-results');
            resDiv.innerHTML = `<div class="p-10 text-center text-xs animate-pulse text-slate-400">Processing Cloud Data...</div>`;

            try {
                const snap = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', 'attendance'));
                reportData = [];
                snap.forEach(doc => {
                    const data = doc.data();
                    if(data.date >= from && data.date <= to) reportData.push(data);
                });
                reportData.sort((a,b) => b.timestamp - a.timestamp);
                document.getElementById('btn-export').classList.toggle('hidden', reportData.length === 0);
                renderReportResults();
            } catch(e) { resDiv.innerHTML = `<p class="text-red-500 text-xs text-center">Fetch failed</p>`; }
        };

        function renderReportResults() {
            const resDiv = document.getElementById('report-results');
            if (reportData.length === 0) {
                resDiv.innerHTML = `<p class="text-center py-10 text-slate-400 text-xs uppercase font-black">No Records Found</p>`;
                return;
            }

            if (reportMode === 'sessions') {
                resDiv.innerHTML = reportData.map(r => `
                    <div class="bg-white p-4 rounded-2xl border border-slate-200">
                        <div class="flex justify-between items-start mb-2">
                            <h4 class="text-xs font-black text-blue-600">${r.date} | Hr ${r.hour}</h4>
                            <span class="text-[9px] font-black text-red-500 bg-red-50 px-2 py-1 rounded">${r.absentees.length} ABSENT</span>
                        </div>
                        <p class="text-[10px] font-bold text-slate-500 mb-2">${r.subject} (${r.section})</p>
                        <div class="text-[9px] text-slate-400 font-mono bg-slate-50 p-2 rounded break-all">
                            ${r.absentees.join(", ") || "None"}
                        </div>
                    </div>
                `).join('');
            } else {
                // STUDENT ANALYTICS MODE
                const stats = {};
                const months = {};
                
                // Aggregate data
                reportData.forEach(session => {
                    const monthKey = session.date.substring(0, 7); // YYYY-MM
                    months[monthKey] = (months[monthKey] || 0) + 1;

                    studentsList.forEach(student => {
                        if (session.section === 'All' || session.section === student.section) {
                            if (!stats[student.roll]) stats[student.roll] = { total: 0, absent: 0, byMonth: {}, name: student.name };
                            stats[student.roll].total++;
                            if (!stats[student.roll].byMonth[monthKey]) stats[student.roll].byMonth[monthKey] = { total: 0, absent: 0 };
                            stats[student.roll].byMonth[monthKey].total++;
                            
                            if (session.absentees.includes(student.roll)) {
                                stats[student.roll].absent++;
                                stats[student.roll].byMonth[monthKey].absent++;
                            }
                        }
                    });
                });

                const sortedStats = Object.entries(stats).sort((a, b) => (a[1].absent/a[1].total) - (b[1].absent/b[1].total));

                resDiv.innerHTML = `
                    <div class="bg-blue-600 text-white p-5 rounded-2xl mb-4 shadow-lg">
                        <p class="text-[10px] font-black uppercase tracking-widest opacity-80 mb-1">Period Summary</p>
                        <h2 class="text-xl font-black">${reportData.length} Total Sessions</h2>
                        <div class="flex gap-4 mt-3">
                            <div><p class="text-[9px] opacity-70">Avg Attendance</p><p class="text-sm font-black">${( (1 - (reportData.reduce((acc, s) => acc + s.absentees.length, 0) / (reportData.length * studentsList.length || 1))) * 100 ).toFixed(1)}%</p></div>
                            <div><p class="text-[9px] opacity-70">Active Students</p><p class="text-sm font-black">${studentsList.length}</p></div>
                        </div>
                    </div>
                ` + sortedStats.map(([roll, data]) => {
                    const perc = ((data.total - data.absent) / data.total * 100).toFixed(0);
                    const color = perc >= 75 ? 'emerald' : perc >= 60 ? 'orange' : 'red';
                    
                    return `
                        <div class="bg-white p-4 rounded-2xl border border-slate-200 shadow-sm">
                            <div class="flex justify-between items-center mb-3">
                                <div>
                                    <h4 class="text-xs font-black">${data.name}</h4>
                                    <p class="text-[9px] font-mono text-slate-400">${roll}</p>
                                </div>
                                <div class="text-right">
                                    <p class="text-lg font-black text-${color}-600 leading-none">${perc}%</p>
                                    <p class="text-[8px] font-black text-slate-400 uppercase mt-1">Regularity</p>
                                </div>
                            </div>
                            
                            <div class="progress-bg mb-3">
                                <div class="progress-fill bg-${color}-500" style="width: ${perc}%"></div>
                            </div>

                            <div class="grid grid-cols-3 gap-2 mb-3">
                                <div class="bg-slate-50 p-2 rounded-lg text-center">
                                    <p class="text-[8px] font-black text-slate-400 uppercase">Classes</p>
                                    <p class="text-xs font-bold">${data.total}</p>
                                </div>
                                <div class="bg-slate-50 p-2 rounded-lg text-center">
                                    <p class="text-[8px] font-black text-slate-400 uppercase">Present</p>
                                    <p class="text-xs font-bold text-emerald-600">${data.total - data.absent}</p>
                                </div>
                                <div class="bg-slate-50 p-2 rounded-lg text-center">
                                    <p class="text-[8px] font-black text-slate-400 uppercase">Absent</p>
                                    <p class="text-xs font-bold text-red-600">${data.absent}</p>
                                </div>
                            </div>

                            <div class="space-y-1 border-t pt-2">
                                <p class="text-[8px] font-black text-slate-400 uppercase mb-2">Monthly Breakdown</p>
                                ${Object.entries(data.byMonth).map(([month, mdata]) => `
                                    <div class="flex items-center justify-between text-[10px]">
                                        <span class="text-slate-500 font-bold">${month}</span>
                                        <div class="flex gap-3">
                                            <span class="text-emerald-600 font-black">${mdata.total - mdata.absent}P</span>
                                            <span class="text-red-500 font-black">${mdata.absent}A</span>
                                            <span class="w-8 text-right font-mono">${((mdata.total - mdata.absent)/mdata.total*100).toFixed(0)}%</span>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }).join('');
            }
        }

        window.exportToCSV = () => {
            const headers = ["Date", "Hour", "Faculty", "Section", "Subject", "Absent_Rolls"];
            let csv = headers.join(",") + "\n";
            reportData.forEach(r => {
                csv += `${r.date},${r.hour},"${r.faculty}",${r.section},"${r.subject}","${r.absentees.join(", ")}"\n`;
            });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv' }));
            link.download = `Report_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        };

        window.showModal = (title, body, actionHtml = "") => {
            document.getElementById('modal-title').innerText = title;
            document.getElementById('modal-body').innerText = body;
            const container = document.getElementById('modal-actions');
            container.innerHTML = `<button onclick="window.closeModal()" class="flex-1 py-3 bg-slate-100 rounded-xl text-xs font-bold uppercase">Close</button>`;
            if(actionHtml) container.innerHTML = actionHtml + container.innerHTML;
            document.getElementById('custom-modal').classList.remove('hidden');
        };

        window.closeModal = () => document.getElementById('custom-modal').classList.add('hidden');

        function updateConnectionStatus() {
            const badge = document.getElementById('status-badge');
            const isOnline = navigator.onLine && !!currentUser;
            badge.innerText = isOnline ? "‚óè System Online" : "‚óã Offline/Syncing...";
            badge.className = `text-[10px] font-bold uppercase ${isOnline ? 'text-green-500' : 'text-slate-400'}`;
        }
    </script>
</body>
</html>
